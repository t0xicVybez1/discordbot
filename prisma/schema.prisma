generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// Guild (Discord Server)
// ─────────────────────────────────────────────
model Guild {
  id        String   @id               // Discord guild ID
  name      String
  iconUrl   String?
  ownerId   String
  joinedAt  DateTime @default(now())
  leftAt    DateTime?
  isActive  Boolean  @default(true)

  settings        GuildSettings?
  moderationCases ModerationCase[]
  userLevels      UserLevel[]
  warnings        Warning[]
  reactionRoles   ReactionRole[]
  customCommands  CustomCommand[]
  addonData       AddonData[]
  logEntries      LogEntry[]
  automodConfig   AutoModConfig?
  welcomeConfig   WelcomeConfig?
  musicQueue      MusicQueue?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("guilds")
}

// ─────────────────────────────────────────────
// Guild Settings (one-to-one with Guild)
// ─────────────────────────────────────────────
model GuildSettings {
  id      String @id @default(cuid())
  guildId String @unique
  guild   Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

  // Prefix & locale
  prefix  String  @default("!")
  locale  String  @default("en-US")
  timezone String @default("UTC")

  // Feature toggles
  moderationEnabled  Boolean @default(true)
  autoModEnabled     Boolean @default(false)
  levelingEnabled    Boolean @default(true)
  welcomeEnabled     Boolean @default(false)
  loggingEnabled     Boolean @default(false)
  musicEnabled       Boolean @default(true)
  reactionRolesEnabled Boolean @default(false)

  // Channel IDs
  logChannelId      String?
  modLogChannelId   String?
  welcomeChannelId  String?
  leaveChannelId    String?
  levelUpChannelId  String?

  // Role IDs
  muteRoleId        String?
  autoRoleId        String?
  memberRoleId      String?

  // Leveling config
  xpPerMessage      Int     @default(15)
  xpCooldown        Int     @default(60)
  levelUpMessage    String  @default("Congratulations {user}, you reached level {level}!")

  // Raw JSON for extended settings
  extended          Json    @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("guild_settings")
}

// ─────────────────────────────────────────────
// Auto-Mod Configuration
// ─────────────────────────────────────────────
model AutoModConfig {
  id      String @id @default(cuid())
  guildId String @unique
  guild   Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

  // Spam protection
  antiSpamEnabled    Boolean  @default(false)
  antiSpamThreshold  Int      @default(5)
  antiSpamInterval   Int      @default(5000)
  antiSpamAction     String   @default("delete")

  // Word filter
  filterEnabled      Boolean  @default(false)
  filteredWords      String[] @default([])
  filterAction       String   @default("delete")

  // Link filter
  antiLinkEnabled    Boolean  @default(false)
  allowedDomains     String[] @default([])
  linkAction         String   @default("delete")

  // Mention spam
  antiMentionEnabled Boolean  @default(false)
  mentionThreshold   Int      @default(5)

  // Caps filter
  antiCapsEnabled    Boolean  @default(false)
  capsThreshold      Int      @default(70)

  // Anti-raid
  antiRaidEnabled    Boolean  @default(false)
  raidThreshold      Int      @default(10)
  raidInterval       Int      @default(10000)
  raidAction         String   @default("lockdown")

  // Exempt roles/channels
  exemptRoles        String[] @default([])
  exemptChannels     String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("automod_configs")
}

// ─────────────────────────────────────────────
// Welcome / Leave Config
// ─────────────────────────────────────────────
model WelcomeConfig {
  id      String @id @default(cuid())
  guildId String @unique
  guild   Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)

  welcomeEnabled    Boolean @default(false)
  welcomeChannelId  String?
  welcomeMessage    String  @default("Welcome {user} to **{server}**! You are member #{memberCount}.")
  welcomeEmbed      Boolean @default(true)
  welcomeColor      String  @default("#5865F2")
  welcomeDMEnabled  Boolean @default(false)
  welcomeDMMessage  String  @default("Welcome to {server}!")

  leaveEnabled      Boolean @default(false)
  leaveChannelId    String?
  leaveMessage      String  @default("{user} has left the server. We now have {memberCount} members.")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("welcome_configs")
}

// ─────────────────────────────────────────────
// Moderation Cases
// ─────────────────────────────────────────────
model ModerationCase {
  id          String   @id @default(cuid())
  caseNumber  Int
  guildId     String
  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)

  type        String   // ban, kick, mute, warn, unban, unmute
  userId      String
  userTag     String
  moderatorId String
  moderatorTag String
  reason      String   @default("No reason provided")
  duration    Int?     // seconds for mute/tempban
  expiresAt   DateTime?
  active      Boolean  @default(true)
  messageUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, caseNumber])
  @@index([guildId, userId])
  @@map("moderation_cases")
}

// ─────────────────────────────────────────────
// Warnings
// ─────────────────────────────────────────────
model Warning {
  id          String   @id @default(cuid())
  guildId     String
  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  userId      String
  moderatorId String
  reason      String
  active      Boolean  @default(true)

  createdAt DateTime @default(now())

  @@index([guildId, userId])
  @@map("warnings")
}

// ─────────────────────────────────────────────
// User Levels / XP
// ─────────────────────────────────────────────
model UserLevel {
  id      String @id @default(cuid())
  guildId String
  guild   Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)
  userId  String
  userTag String
  xp      Int    @default(0)
  level   Int    @default(0)
  totalMessages Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, userId])
  @@index([guildId, xp(sort: Desc)])
  @@map("user_levels")
}

// ─────────────────────────────────────────────
// Reaction Roles
// ─────────────────────────────────────────────
model ReactionRole {
  id        String @id @default(cuid())
  guildId   String
  guild     Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)
  channelId String
  messageId String
  emoji     String
  roleId    String
  type      String @default("toggle") // toggle, add, remove

  createdAt DateTime @default(now())

  @@unique([messageId, emoji])
  @@index([guildId])
  @@map("reaction_roles")
}

// ─────────────────────────────────────────────
// Custom Commands
// ─────────────────────────────────────────────
model CustomCommand {
  id        String  @id @default(cuid())
  guildId   String
  guild     Guild   @relation(fields: [guildId], references: [id], onDelete: Cascade)
  name      String
  response  String
  embed     Boolean @default(false)
  enabled   Boolean @default(true)
  uses      Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, name])
  @@map("custom_commands")
}

// ─────────────────────────────────────────────
// Music Queue (persisted for resuming)
// ─────────────────────────────────────────────
model MusicQueue {
  id        String @id @default(cuid())
  guildId   String @unique
  guild     Guild  @relation(fields: [guildId], references: [id], onDelete: Cascade)
  tracks    Json   @default("[]")
  volume    Int    @default(100)
  loop      String @default("none") // none, track, queue

  updatedAt DateTime @updatedAt

  @@map("music_queues")
}

// ─────────────────────────────────────────────
// Log Entries
// ─────────────────────────────────────────────
model LogEntry {
  id        String   @id @default(cuid())
  guildId   String
  guild     Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  type      String
  userId    String?
  data      Json     @default("{}")
  createdAt DateTime @default(now())

  @@index([guildId, createdAt(sort: Desc)])
  @@index([guildId, type])
  @@map("log_entries")
}

// ─────────────────────────────────────────────
// Portal Users (OAuth sessions)
// ─────────────────────────────────────────────
model PortalUser {
  id            String   @id               // Discord user ID
  username      String
  discriminator String   @default("0")
  avatar        String?
  email         String?
  accessToken   String?
  refreshToken  String?
  tokenExpires  DateTime?
  isStaff       Boolean  @default(false)
  isBotOwner    Boolean  @default(false)

  sessions      UserSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("portal_users")
}

// ─────────────────────────────────────────────
// User Sessions (JWT refresh tracking)
// ─────────────────────────────────────────────
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  user      PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ipAddress String?

  createdAt DateTime @default(now())

  @@map("user_sessions")
}

// ─────────────────────────────────────────────
// Addons Registry
// ─────────────────────────────────────────────
model Addon {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  version     String
  description String
  author      String
  homepage    String?
  enabled     Boolean  @default(true)
  verified    Boolean  @default(false)
  manifest    Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guildAddons GuildAddon[]
  addonData   AddonData[]

  @@map("addons")
}

// ─────────────────────────────────────────────
// Guild <> Addon (per-guild addon settings)
// ─────────────────────────────────────────────
model GuildAddon {
  id       String @id @default(cuid())
  guildId  String
  addonId  String
  addon    Addon  @relation(fields: [addonId], references: [id], onDelete: Cascade)
  enabled  Boolean @default(true)
  settings Json    @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, addonId])
  @@map("guild_addons")
}

// ─────────────────────────────────────────────
// Addon Data Store (KV per addon per guild)
// ─────────────────────────────────────────────
model AddonData {
  id      String  @id @default(cuid())
  guildId String?
  guild   Guild?  @relation(fields: [guildId], references: [id], onDelete: Cascade)
  addonId String
  addon   Addon   @relation(fields: [addonId], references: [id], onDelete: Cascade)
  key     String
  value   Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, addonId, key])
  @@index([addonId, key])
  @@map("addon_data")
}

// ─────────────────────────────────────────────
// System Metrics (for staff dashboard)
// ─────────────────────────────────────────────
model SystemMetric {
  id         String   @id @default(cuid())
  metricType String
  value      Float
  metadata   Json     @default("{}")
  recordedAt DateTime @default(now())

  @@index([metricType, recordedAt(sort: Desc)])
  @@map("system_metrics")
}
